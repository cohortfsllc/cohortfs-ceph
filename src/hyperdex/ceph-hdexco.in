#!/bin/sh

# Copyright (C) 2012, CohortFS, LLC <info@cohortfs.com>
# All rights reserved.
#
# This file is licensed under what is commonly known as the New BSD
# License (or the Modified BSD License, or the 3-Clause BSD
# License). See file COPYING.

this=`basename $0`
startstop="/sbin/start-stop-daemon"

# hyperdex executables
cmd="@HYPERDEX_BINDIR@/hyperdex-coordinator"
ctrl="@HYPERDEX_BINDIR@/hyperdex-coordinator-control"

# ceph-specific locations and variables
BINDIR=@bindir@
LIBDIR=@libdir@/ceph
ETCDIR=@sysconfdir@/ceph

do_shutdown() {
  # ignore TERM signals now, so we can finish shutdown
  trap '' TERM 

  local pidfile
  pidfile=$1

  # take down hyperdex-coordinator step-by-step
  $ctrl quiesce
  $ctrl shutdown
  $startstop --pidfile=$pidfile --stop

  exit 0
}

help() {
    echo "Usage: $this:"
    echo "  -i=id                        identifier of instance"
    echo "  --pidfile=path               path to file containing process id"
    # builds off of hyperdex-coordinator's help message
    $cmd --help | grep -vi "^Usage"
}

usage() {
    echo "Usage: $this:"
    echo "        [-i=id] [--pid-file=path]"
    # builds off of hyperdex-coordinator's usage message
    $cmd --usage | grep -v "^Usage"
}

args=`getopt --name "$this" --unquote \
      -l subprocess,pid-file:,help,control-port:,host-port:,logging:,state-file: \
      -o i:hb:c:p:l:s: \
      -- $@`

if [ $? != 0 ] ; then
  help()
  exit 1
fi

set -- $args

while [ $# -gt 0 ] ; do
    case "$1" in
	--subprocess )
	    SUBPROCESS=true ;;
	-c )
	    CONFIG="$2" ; CONFIGFILE="-c $2" ; shift ;;
	--pid-file )
	    PIDFILE="$2" ; CTRLPIDFILE="$2.ctrl" ; shift ;;
	-i )
	    ID="$2" ; shift ;;
	--help | -h )
	    help ; exit 0 ;;
	-b | --bindto )
	    OPTBINDTO="--bindto=$2" ; shift ;;
	--control-port )
	    OPTCONTROLPORT="--control-port=$2" ; shift ;;
	-p | --host-port )
	    OPTHOSTPORT="--host-port=$2" ; shift ;;
	-l | --logging )
	    OPTLOGGING="--logging=$2" ; shift ;;
	-s | --state-file )
	    OPTSTATEFILE="--state-file=$2" ; shift ;;
	-- )
	    shift ; break ;;
	\? )
	    usage ; echo Error: $1 ; exit 1 ;;
	* )
	    usage ; echo Error: illegal argument $1 ; exit 1 ;;
    esac
    shift
done

if [ $# -gt 0 ] ;then
    echo Error: extra arguments -- $*
    echo $USAGE;
    exit 1
fi

if [ -z "$SUBPROCESS" -a -z "$PIDFILE" ] ;then
    echo Error: must supply --pid-file when not a subprocess
    exit 1
fi

# determine if this is the entry process or the sub-process
if [ -z "$SUBPROCESS" ] ;then
    # start this very same script again as a subprocess in the background,
    # we can exit
    $startstop --pidfile=$PIDFILE --make-pidfile --background \
	--startas $0 --start -- --subprocess $OPTBINDTO $OPTCONTROLPORT \
        $OPTHOSTPORT $OPTLOGGING $OPTSTATEFILE --pid-file=$PIDFILE \
        $CONFIGFILE -i $ID
else
    # ceph_common.sh expects these to be set
    type=hdexco
    id=$ID
    verbose=0

    # load in ceph_common.sh library and verify config file
    . $LIBDIR/ceph_common.sh
    if [ -n "$CONFIG" ] ;then
	conf="$CONFIG"
    fi
    verify_conf

    # for any options not set on command-line, use config file
    config_option OPTBINDTO "--bind-to" "" "bind-to"
    config_option OPTCONTROLPORT "--control-port" "" "ctrl port"
    config_option OPTHOSTPORT "--host-port" "" "host port"
    config_option OPTLOGGING "--logging" "" "logging"
    config_option OPTSTATEFILE "--state-file" "" "state file"

    # handle TERM signals w/ do_shutdown function above to gracefully
    # bring down the hyperdex coordinator
    trap "do_shutdown $CTRLPIDFILE" TERM

    $startstop --pidfile=$CTRLPIDFILE --make-pidfile --background --startas \
               $cmd --start -- $OPTBINDTO $OPTCONTROLPORT $OPTHOSTPORT \
               $OPTLOGGING $OPTSTATEFILE

    # busy loop so script continues to run, waiting for TERM
    while true ; do
	sleep 5
    done
fi
