#!/bin/sh

# Copyright (C) 2012, CohortFS, LLC <info@cohortfs.com>
# All rights reserved.
#
# This file is licensed under what is commonly known as the New BSD
# License (or the Modified BSD License, or the 3-Clause BSD
# License). See file COPYING.

this=`basename $0`
startstop="/sbin/start-stop-daemon"

# hyperdex executables
cmd="@HYPERDEX_BINDIR@/hyperdex-daemon"

# ceph-specific locations and variables
BINDIR=@bindir@
LIBDIR=@libdir@/ceph
ETCDIR=@sysconfdir@/ceph

help() {
    echo "Usage: $this:"
    echo "  -i=id                        identifier of instance"
    echo "  --pidfile=path               path to file containing process id"
    $cmd --help | grep -v "^Usage"
}

usage() {
    echo "Usage: $this:"
    echo "        [-i=id] [--pidfile=path]"
    $cmd --usage | grep -v "^Usage"
}

args=`getopt --name "$this" --unquote \
      -l pid-file:,data:,host:,port:,threads:,bind-to:,incoming-port:outgoing-port:,help,usage \
      -o i:c:D:h:p:t:b:i:o: \
      -- $@`

if [ $? != 0 ] ; then
  help()
  exit 1
fi

set -- $args

while [ $# -gt 0 ] ; do
    case "$1" in
	-i )
	    ID=$2 ; shift ;;
	--pid-file )
	    PIDFILE="$2" ; shift ;;
	-c )
	    CONFIG="$2" ; shift ;;
	-D | --data )
	    DATADIR="$2" ; OPTDATA="--data=$2" ; shift ;;
	-h | --host )
	    OPTHOST="--host=$2" ; shift ;;
	-p | --port )
	    OPTPORT="--port=$2" ; shift ;;
	-t | --threads )
	    OPTTHREADS="--threads=$2" ; shift ;;
	-b | --bind-to )
	    OPTBINDTO="--bind-to=$2" ; shift ;;
	-i | --incoming-port )
	    OPTINCOMING="--incoming-port=$2" ; shift ;;
	-o | --outgoing-port )
	    OPTOUTGOING="--outgoing-port=$2" ; shift ;;
	--help )
	    help ; exit 0 ;;
	--usage )
	    usage ; exit 0 ;;
	-- )
	    shift ; break ;;
	\? )
	    usage ; echo Error: $1 ; exit 1 ;;
	* )
	    usage ; echo Error: illegal argument $1 ; exit 1 ;;
    esac
    shift
done

if [ $# -gt 0 ] ;then
    echo Error: extra arguments -- $*
    echo $USAGE;
    exit 1
fi

# ceph_common.sh expects these to be set
type=hdexd
id=$ID
verbose=0

# load in ceph_common.sh library and verify config file
. $LIBDIR/ceph_common.sh
if [ -n "$CONFIG" ] ;then
    conf="$CONFIG"
fi
verify_conf

# for any options not set on command-line, use config file
config_option OPTDATA "--data" "" "data"
config_option OPTHOST "--host" "" "coordinator host"
config_option OPTPORT "--port" "" "coordinator port"
config_option OPTTHREADS "--threads" "" "threads"
config_option OPTBINDTO "--bind-to" "" "bind-to"
config_option OPTINCOMING "--incoming-port" "" "incoming port"
config_option OPTOUTGOING "--outgoing-port" "" "outgoing port"

$startstop --pidfile=$PIDFILE --make-pidfile --background --startas \
    $cmd --start -- --foreground $OPTDATA $OPTHOST $OPTPORT \
    $OPTTHREADS $OPTBINDTO $OPTINCOMING $OPTOUTGOING

exit $?
